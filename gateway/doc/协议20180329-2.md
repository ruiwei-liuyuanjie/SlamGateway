变更说明：
	
	2018/03/29:	增加msgIndex详细说明
					增加gateway与ctrl建立链接关系的方法。


一. 通讯对象：

	1.结构
	web+调度  Schedule<===>  网关 GateWay<===========> 小车Slam
                                  	\\========>小车控制板子Ctrl
	2.英文缩写：
		调度：schedule
		网关：gateway
		小车：slam
		控制板：ctrl
		终端：term
	3.MQTT配置：
		适用用户名密码认证连接
		QOS设置为2，保证消息可靠唯一到达。
	4.通讯流程：
		调度负责小车运行控制，以任务的方式发布一个消息到网关。网关解析任务。调度不直接访问slam和ctrl.
	 	网关起驱动sdk控制Slam，和透和转换传控制指令到Ctrl，和屏蔽各种小车差异的功能。
		网关定时收集一些状态信息上报给调度。频率暂定1s, 这些信息作为调度需要处理的事件，网关根据这些信息决定下一步该怎么做。
	5.关于配置：
		所有配置由web访问， 网关的配置也由web端/schedule断下发，目前先以配置文件的方式作为调试
	
二.调度-网关
	
	1.调度下发任务报文
	作用例如让单个小车去哪里充电，或去哪里等候，去哪里端盘子：
	传输方向： schedule -> gateway
	topic:	rw/slam/{single|group}/{index}    (single单个控制，group按组控制，index为设备id，目前先实现单个控制）
	message定义：
	{
	    "messageType":"command",		/*命令类型: 取值固定为command ，info用于回传*/
	    "timestamp":1515762490,		/*时间戳: 取值u32, 使用utc秒数*/
    	//"msgIndex": 0，			/*消息序号: 取值u64, 从0开始，每次命令递增1， 用于命令次序检查，防止先发后到的情况以及错误恢复使用。该序号由发送者递增1，接受者检查*/
	    "from":"rw/term/single/1/1",	/*命令来源: 指明呼叫的对象？？ */
	    {/*其他补充字段*/...}
	    "submessages":[ 			/*子命令集合，子命令对象格式依据submessage字段规定*/
	  	{/*子命令1*/}
	  	{/*子命令2*/}
	  	{/*子命令 3*/}...
	    ]
	}
	submessages子命令类型字段取值包括：取值moveTo(移动),chargeConnect(充电),serve(牵引棒控制)，ctrl(手动方向控制)
	移动子命令：
	{
	    "submessage":"moveTo", 
	    "points":[{"x":"100", "y":"100"}, {"x":"100", "y":"200"}], 		/*坐标点集合, */
	    "appending":"0", 							/*追加，否则清除之前的数据*/
	    "isMilestone":"0",							/*路径规划，否则直线到达目的点*/
	}           
	充电：
	{
		"submessage":"chargeConnect",
		"slot":"0"				//充电桩序号
		
	}
	牵引棒子命令： 
	{
		"submessage":"serve", 
		"timeout":1000,			//超时,单位ms
		"action":"up|down"		//动作，up举起，down放下
	}   
	手动方向控制:
	{
		"submessage":"ctrl",
		"direct":"backward,frontward,leftward,rightward,stop"		//方向,stop用于立即停止，取消先前的命令
	}
	
	2网关定时回复的报文：
	传输方向： gateway -> schedule
	topic:	rw/slam/state
	message定义：
	{
		"messageType":"info",			/*命令类型: 取值固定为info*/
	    "timestamp":"1515762490",		/*时间戳: 取值u32, 使用utc秒数*/
		//"msgIndex": "0"，			/*消息序号: 取值u64, 从0开始，发送者递增1，接受者检查*/	
		"slams":[				/*每个小车一个状态*/
			{
				"index":"0",		//小车id
				"task":"moveTo"，	//当期任务
				"state":"idle|busy|fault|charging",	//状态
				"location":"1.0,1.5",			//当期位置
				"battery":"50",				//当期电量
				"serveState":"up|down|running",		//当前牵引棒状态。
				"faultInfo":"",				/*额外的错误信息，如果执行成功该字段为 "" ，id不同步时为："id_error" */
				"rotation"："1.0,1.0,1.0",			//当前姿态，方向
			},
			...				//
		]
		
	}

三.网关和控制板的通讯格式
	
	网关和控制板采用 主(网关)-从(控制板) 模式， 一问一答通讯机制。协作期间控制板主动发送心跳。心跳间隔30s
	一次会话流程为 网关发布命令， 控制板执行命令， 执行完成后回复发布消息
	1.网关发布命令给控制板，所有：
	传输方向：gateway->ctrl
	topic:/rw/ctrl/all
	说明：控制板开机首先订阅该消息
	{
		"messageType":"slamInfo",		/*slam sdk ip 配置表*/
	    "timestamp":1515762490,		/*时间戳: 取值u32, 使用utc秒数*/
		"msgIndex": 0，					/*消息序号: 取值u64, 从0开始，发送者递增1，接受者检查*/
		"message":[
			{
				"index":0						/*小车的序号*/
				"slamIp":"192.168.1.100"		/*小车slam的ip*/
				"slamPort":1446				/*小车的port*/
			},	
			{
				"index":1
				"slamIp":"192.168.1.102"
			},	
			...			//其他
		]
	}
	2.网关发布命令给控制板，单一
	传输方向：gateway->ctrl
	topic:/rw/ctrl/{single|group}/{index}
	{
		"messageType":"chargeConnect|serve|getState",	/*命令类型: 充电或牵引棒,获取状态*/
	    "timestamp":1515762490,		/*时间戳: 取值u32, 使用utc秒数*/
		"msgIndex": 0，			/*消息序号: 取值u64, 从0开始，发送者递增1，接受者检查*/
		"message":{/* 消息对象 */}
	}
	充电消息：
	{
		"slot":0				//充电桩序号
	}
	牵引棒子消息： 
	{
		"timeout":1000,			//超时单位ms
		"action":"up|down"		//动作，up举起，down放下
	}   
	

	2.控制板回复网关：
	传输方向：ctrl->gateway 
	topic:/rw/ctrl/{index}
	{
		"messageType":"chargeConnect|serve|getState",	/*命令类型: 充电或牵引棒*/
	    "timestamp":1515762490,				/*时间戳: 取值u32, 使用utc秒数*/
		"msgIndex": 0，							/*消息序号: 取值u64, 从0开始，发送者递增1，接受者检查*/
		"result":"ok|error|{ip}",				/*执行结果, 其中，ip 收到网关发送 /rw/ctrl/all 后，回复的自己的ip, 让网关知道自己在线*/
		"faultInfo":""								/*额外的错误信息，如果执行成功该字段为 "" */
	}
	
四.网关与控制板链接的说明
	
	当网关根据配置的slam IP地址去初始化sdk所有的小车，成功后，发布/rw/ctrl/all 里面包含了ip地址和index的对应表.
	小车根据自己ip和slam的ip关系确定自己输入那个index，然后订阅自己的topic即 /rm/ctrl/single/{index}.
	然后小车应该发布一个回应给网关告诉网关他存在。即result 值为自己的ip.
	网关根据所有回复，判断各个index的控制板都存在，完成了初始化工作。

五.msgIndex 说明：
	
	说明：msgIndex只作为消息同步的措施，不强制限制发送流程。
	举例：
	当主机发布了一个消息msgIndex=5， 只有当从机回复msgIndex从5变为6， 可以确定从机完成主机分配的任务
	当从机的回复消息msgIndex<5时，出现丢包或者重启。主机应该重新根据状态去处理。
	

	


